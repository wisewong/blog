<!DOCTYPE html>
<html >
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>sql server 事务处理 | Sage Wong</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="事物处理 
事务是SQL Server中的单个逻辑单元，一个事务内的所有SQL语句作为一个整体执行，要么全部执行，要么都不执行。 
事务有4个属性，称为ACID（原子性、一致性、隔离性和持久性） 
原子性  事务必须是原子工作单元。对于其数据修改，要么全都执行，要么全都不执行。 
一致性  事务在完成时，必须使所有的数据都保持一致状态。 
隔离性  由并发事务所做的修改必须与任何其他并发事务所做的">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="sql server 事务处理 | Sage Wong">
    <meta name="twitter:description" content="事物处理 
事务是SQL Server中的单个逻辑单元，一个事务内的所有SQL语句作为一个整体执行，要么全部执行，要么都不执行。 
事务有4个属性，称为ACID（原子性、一致性、隔离性和持久性） 
原子性  事务必须是原子工作单元。对于其数据修改，要么全都执行，要么全都不执行。 
一致性  事务在完成时，必须使所有的数据都保持一致状态。 
隔离性  由并发事务所做的修改必须与任何其他并发事务所做的">

    <meta property="og:type" content="article">
    <meta property="og:title" content="sql server 事务处理 | Sage Wong">
    <meta property="og:description" content="事物处理 
事务是SQL Server中的单个逻辑单元，一个事务内的所有SQL语句作为一个整体执行，要么全部执行，要么都不执行。 
事务有4个属性，称为ACID（原子性、一致性、隔离性和持久性） 
原子性  事务必须是原子工作单元。对于其数据修改，要么全都执行，要么全都不执行。 
一致性  事务在完成时，必须使所有的数据都保持一致状态。 
隔离性  由并发事务所做的修改必须与任何其他并发事务所做的">

    
    <meta name="author" content="sage wong">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/avatar-small.png">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Sage Wong" href="/atom.xml">
    

    <link rel="canonical" href="http://yoursite.com/2016/02/18/sql server 事务处理/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/bkc.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Sage Wong 的主页"><img src="/images/touxiang.jpg" width="80" alt="Sage Wong logo" class="panel-cover__logo logo"></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Sage Wong">Sage Wong</a></h1>
        
        <hr class="panel-cover__divider">
        <p class="panel-cover__description"></p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="Visit the blog" class="blog-button">Blog</a></li>
            
              <li class="navigation__item"><a href="/aboutme">关于我</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="https://weibo.com/z941030" title="Weibo" target="_blank">
      <i class="social fa fa-weibo"></i>
      <span class="label">Weibo</span>
    </a>
  </li> 


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/wisewong" title="GitHub" target="_blank">
      <i class="social fa fa-github"></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  <li class="navigation__item">
    <a href="https://twitter.com/mr_xlz" title="Twitter" target="_blank">
      <i class="social fa fa-twitter"></i>
      <span class="label">Twitter</span>
    </a>
  </li>

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class="social fa fa-rss"></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-disabled"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2016-02-18T13:26:15.000Z" class="post-list__meta--date date">2016-02-18</time> &#8226; <span class="post-meta__tags tags">于  </span>
      <span class="page-pv">
       Read <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">sql server 事务处理</h1>
  </header>

  <section class="post">
    <p>事物处理 </p>
<p>事务是SQL Server中的单个逻辑单元，一个事务内的所有SQL语句作为一个整体执行，要么全部执行，要么都不执行。 </p>
<p>事务有4个属性，称为ACID（原子性、一致性、隔离性和持久性） </p>
<p>原子性  事务必须是原子工作单元。对于其数据修改，要么全都执行，要么全都不执行。 </p>
<p>一致性  事务在完成时，必须使所有的数据都保持一致状态。 </p>
<p>隔离性  由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。 </p>
<p>持久性  事务完成之后，它对于系统的影响是永久性的。 </p>
<p>事务分类 </p>
<p>按事务的启动和执行方式，可将事务分为3类： </p>
<p>1.显示事务  ：显式地定义启动和结束的事务。 </p>
<p>2.自动提交事务  ：自动提交模式是SQL Server的默认事务管理模式。每个Transact-SQL语句在完成时，都被提交或回滚。如果一个语句成功地完成，则提交该语句；如果遇到错误，则回滚该语句。 </p>
<p>3.隐性事务  ：当连接以隐性事务模式进行操作时，SQL Server将在提交或回滚当前事务后自动启动新事务。无须描述事务的开始，只须提交或回滚每个事务。隐性事务模式形成连续的事务链。 </p>
<p>1.显示事务 </p>
<p>显示事务需要显示地定义事务的启动和结束。 </p>
<p>它是通过  BEGIN  TRANSACTION  、  COMMIT  TRANSACTION  、  ROLLBACK  TRANSACTION  、  SAVE  TRANSACTION  等Transact-SQL语句来完成的。 </p>
<p>启动事务：  BEGIN  TRANSACTION  。 </p>
<p>结束事务：  COMMIT  TRANSACTION  。例如： </p>
<pre><code>use test
go

/*启动一个事务向student表中插入一个记录*/
begin transaction
insert into student  values(100,&apos;陈浩&apos;,&apos;男&apos;,19)
commit tran

select * from student   
go
</code></pre><p>回滚事务：  ROLLBACK  TRANSACTION  。例如： </p>
<pre><code>/*启动一个事务向student表中删除一个记录，然后回滚该事务*/
begin transaction
delete student  where sno=100
rollback

select * from student    --由于回滚该事务，因此student表中没有插入记录。
go
</code></pre><p>在事务内设置保存点：  SAVE  TRANSACTION  。  保存点是如果有条件的取消事务的一部分，事务可以返回的位置。例如： </p>
<pre><code>/*在事务内设置保存点*/
begin transaction mytran         --启动事务
select * from student
save transaction s1      --设置保存点。
insert into student values(200,&apos;王洪&apos;,&apos;男&apos;,22)   --插入另一个学生的记录
rollback transaction s1   --事务回滚到保存点s1
commit transaction
go 
select * from student     --陈浩插入到表中而王洪没有插入到表中
</code></pre><p>不能用于事务的操作： </p>
<p>操作 </p>
<p>| </p>
<p>相应的SQL语句   </p>
<p>—|—  </p>
<p>创建数据库 </p>
<p>| </p>
<p>CREATE DATABASE   </p>
<p>修改数据库 </p>
<p>| </p>
<p>ALTER DATABASE   </p>
<p>删除数据库 </p>
<p>| </p>
<p>DROP DATABASE   </p>
<p>恢复数据库 </p>
<p>| </p>
<p>RESTORE DATABASE   </p>
<p>加载数据库 </p>
<p>| </p>
<p>LOAD DATABASE   </p>
<p>备份日志文件 </p>
<p>| </p>
<p>BACKUP LOG   </p>
<p>恢复日志文件 </p>
<p>| </p>
<p>RESTORE LOG   </p>
<p>更新统计数据 </p>
<p>| </p>
<p>UPDATE STATISTICS   </p>
<p>授权操作 </p>
<p>| </p>
<p>GRANT   </p>
<p>复制事务日志 </p>
<p>| </p>
<p>DUMP TRANSACTION   </p>
<p>磁盘初始化 </p>
<p>| </p>
<p>DISK INIT   </p>
<p>更新使用sp_configure系统存储过程更改的配置选项的当前配置值 </p>
<p>| </p>
<p>RECONFIGURE   </p>
<p>2.自动提交事务 </p>
<p>SQL Server没有使用BEGIN TRANSACTION语句启动显式事务，或隐性事务模式未打开，将以自动提交模式进行操作。 </p>
<p>当提交或回滚显式事务或者关闭隐性事务模式时，SQL Server将返回到自动提交模式。 </p>
<p>3.隐式事务 </p>
<p>隐性事务模式设置为打开之后，当SQL Server首次执行某些Transact-SQL语句时，都会自动启动一个事务，而不需要使用  BEGIN  TRANSACTION  语句。 </p>
<p>启动新事务的Transact-SQL语句包括： </p>
<p><img src="http://images2015.cnblogs.com/blog/740591/201602/740591-20160218210453128-2023892124.png" alt=""></p>
<p>在发出  COMMIT  或  ROLLBACK  语句之前，该事务一直保持有效。在第一个事务被提交或回滚之后，下次当连接执行这些语句的任何语句时，SQL Server都将自动启动一个新事务。 </p>
<p>隐性事务模式可以通过使用SET语句来打开或者关闭，其语法格式为：  SET  IMPLICIT_TRANSACTIONS {  ON  |  OFF  } </p>
<p>隐性事务模式打开时，用户必须在该事务结束时显式提交或回滚。 </p>
<p>隐性事务模式将保持有效，直到执行  SET  IMPLICIT_TRANSACTIONS  OFF  语句使连接返回到自动提交模式。 </p>
<p>例如： </p>
<pre><code>/*演示在将IMPLICIT_TRANSACTIONS设置为ON时显式或隐式启动事务。
使用@@trancount函数返回当前连接的活动事务数。 */
set nocount on
print cast(@@trancount as char(5))
create table table1(a int)
insert table1 values(1)
go 
print cast(@@trancount as char(5))

print &apos;使用显式事务&apos;
begin tran
insert table1 values(2)
print &apos;当前连接的活动事务数：&apos;+cast(@@trancount as char(5))
commit tran

print &apos;当前连接的活动事务数：&apos;+cast(@@trancount as char(5))
go 

print &apos;设置 implicit_transactions为on&apos;
set implicit_transactions on
go 
print &apos;使用隐式事务&apos;
insert into table1 values(4)  --这里不需要begin tran语句来定义事务的启动
print &apos;当前连接的活动事务数：&apos;+ cast(@@trancount as char(5))
commit tran
print &apos;当前连接的活动事务数：&apos;+ cast(@@trancount as char(5))
go

drop table table1
set implicit_transactions off

/*BEGIN TRANSACTION 语句使 @@TRANCOUNT 递增 1。
ROLLBACK TRANSACTION 将 @@TRANCOUNT 递减为 0，
但 ROLLBACK TRANSACTION savepoint_name 语句并不影响 
@@TRANCOUNT 值。COMMIT TRANSACTION 将 @@TRANCOUNT 递减 1。*/
</code></pre><p>分布式事务 </p>
<p>跨越两个或多个服务器上的数据库的事务就是分布式事务。 </p>
<p>与本地事务的不同在于事务的提交（2pc） </p>
<p>控制分布式事务的T-SQL语句包括：  begin  distributed  transaction  、  commit  transaction  \  commit  work  、  rollback  transaction  \  rollback  work </p>
<p>数据的锁定 </p>
<p>并发问题包括：  修改丢失  ；  脏读  ；  不可重复读  ；  幻读 </p>
<p>事务的隔离级别：  未提交读  ；  提交读  ；  可重复读  ；  可串行读 </p>
<p>SQL SERVER 2005中的锁：  共享锁  ；  排它锁  ；  更新锁  ；  意向锁  ；  架构锁 </p>
<p>封锁技术需要解决的问题：  死锁 </p>
<p>锁的若干自定义操作： </p>
<p>1.通过Set lock_timeout 设置事务被阻塞的  最长时间；通过  @@lock_timeout  查看。例如： </p>
<pre><code>/*查看@@lock_timeout*/
print @@lock_timeout     --LOCKTIMEOUT 的缺省值是 -1,这意味着将没有锁超时

set lock_timeout 1800
print @@lock_timeout
</code></pre><p>2. 定义事务隔离级别（4种）  set  transaction  isolation  level  …  。 </p>
<p>3. 锁定提示。例如： </p>
<pre><code>/*在select，insert，update和delete等语句中使用表级锁定提示*/
set transaction isolation level serializable
begin tran
    select * from student with(tablock)
    exec sp_lock
commit tran

select object_name(1013578649)
</code></pre><p><a href="http://www.cnblogs.com/z941030/" target="_blank" rel="noopener"> 博客园博客:欠扁的小篮子 </a>   </p>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">Newer Post</span>
                <h2 class="post-list__post-title post-title"><a href="/2016/03/02/T-SQL 查询、修改数据表/" title="T-SQL 查询、修改数据表">T-SQL 查询、修改数据表</a></h2>
                <p class="excerpt">
                
                T-SQL修改表数据 
INSERT语句 
语法： 
INSERT[TOP(expression) [PERCENT]][INTO]{  | rowset_function_limited[ WITH ( &amp;lt;Table_Hint_Limited&amp;gt; [ …n ] ) ] /指定表提示/| 
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-03-02T15:13:34.000Z" class="post-list__meta--date date">2016-03-02</time> &#8226; <span class="post-list__meta--tags tags">于 </span><a class="btn-border-small" href="/2016/03/02/T-SQL 查询、修改数据表/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">Older Post</span>
                <h2 class="post-list__post-title post-title"><a href="/2016/01/24/OS存储器管理(一)/" title="OS存储器管理(一)">OS存储器管理(一)</a></h2>
                <p class="excerpt">
                
                存储器的层次： 
分为  寄存器  、  主存（内存）  和  辅存（外存）  三个层次。 
主存  ：  高速缓冲存储器、主存储器、磁盘缓冲存储器， 
主存又称为可执行存储器； 
辅存  ：  固定磁盘存储器、可移动的外部存储器； 
其可长期保存数据，但不能被处理器直接访问。 
此处针对的是在OS
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2016-01-23T18:30:46.000Z" class="post-list__meta--date date">2016-01-24</time> &#8226; <span class="post-list__meta--tags tags">于 </span><a class="btn-border-small" href="/2016/01/24/OS存储器管理(一)/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        &copy; 2019 sage wong - 本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
       
    </span>
    <span class="footer__copyright">
             - 基于 <a href="http://hexo.io">Hexo</a> 搭建，使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题，由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
         </span>
       
    
    
</footer>


        </div>
    </div>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-78918255-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?9cdad07c755fa23f6aced510c6760e87";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
